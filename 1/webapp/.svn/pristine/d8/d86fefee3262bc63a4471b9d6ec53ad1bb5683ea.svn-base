<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>用户管理</title>
<link rel="shortcut icon" href="../../../img/webicon.ico" type="image/x-icon"/>
<link rel="stylesheet" href="../../../css/common/bootstrap.min.css"/>
<link rel="stylesheet" href="../../../css/common/bootstrap-table.min.css">
<link rel="stylesheet" href="../../../js/ueditor/themes/default/css/ueditor.css">
<link href="../../../css/style.css" rel="stylesheet" />
<link href="../../../css/main.css" rel="stylesheet" />
<link href="../../../css/admin.css" rel="stylesheet"/>
</head>
<body>
<script type="text/javascript" src="../../../js/common/header.js"></script>
<div class="mops-con"><!-- 内容部分的class : mops-con (必须) -->
	<div class="con-nav">
		<a href="customer.html">管理中心</a>
		<a href="">-&gt;</a>
		<a href="customer.html">用户管理</a>
	</div><!-- 内容部分导航头的class : con-nav (必须) -->
	<div class="con-box"><!-- 内容部分主体内容的class : con-box (必须) -->
		<!-- 以下为每个页面自己编写的部分 -->
        <input type="hidden" id="id"/>
        <!-- Modal - 短信 -->
        <!-- <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">发送短信</h4>
                    </div>
                    <div class="modal-body">
                        <div class="userList"></div>
                        <div class="messageCon">
                            <div class="messagemodel">
                                <select id="msgmodelsel" class="form-control">
                                     <option value="">--请选择短信模板--</option>
                                     <option value="auditPass">审核通过</option>
                                     <option value="confPay">通知缴费</option>
                                     <option value="confPayState">缴费反馈通知</option>
                                     <option value="stateInvitation">状态变更</option>
                                     <option value="informationChange">会议信息变更</option>
                                     <option value="confPlan">会议安排</option>
                                     <option value="confPlanChange">会议安排变更</option>
                                     <option value="confPayCancle">会议计划取消</option>
                                     <option value="commonNotice">通用模板</option>
                                </select>
                            </div>
                            <div class="msgDetail">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary sendmsg">发送</button>
                    </div>
                </div>
            </div>
        </div> -->
        <!-- Modal - 单个用户信息 -->
        <!-- <div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">用户信息</h4>
                    </div>
                    <div class="modal-body userInfo">
                        <div id="detailform" class="form-horizontal">
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">姓名</label>
                                <div class="col-sm-8">
                                  <input type="text" name="name" class="form-control conference"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">手机</label>
                                <div class="col-sm-8">
                                  <input type="text" name="takepartNum" class="form-control people"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">电子邮箱</label>
                                <div class="col-sm-8">
                                  <input type="text" name="initNum" class="form-control initNum"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="" class="col-sm-2 control-label">单位名称</label>
                                <div class="col-sm-8">
                                  <input type="text" name="name" class="form-control conference"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary sendmsg">发送</button>
                    </div>
                </div>
            </div>
        </div> -->
        <div class="tableModel messagecon none">
            <div class="tableModelTitle">发送短信</div>
            <div>
                <div class="modal-body">
                    <div class="userListMsg"></div>
                    <div class="messageCon">
                        <div class="messagemodel">
                            <select id="msgmodelsel" class="form-control">
                                 <option value="">--请选择短信模板--</option>
                                 <option value="auditPass">审核通过</option>
                                 <option value="confPay">通知缴费</option>
                                 <option value="confPayState">缴费反馈通知</option>
                                 <option value="stateInvitation">状态变更</option>
                                 <option value="informationChange">会议信息变更</option>
                                 <option value="confPlan">会议安排</option>
                                 <option value="confPlanChange">会议安排变更</option>
                                 <option value="confPayCancle">会议计划取消</option>
                                 <option value="commonNotice">通用模板</option>
                            </select>
                        </div>
                        <div class="msgDetail">
                        </div>
                    </div>
                </div>
                <div class="modalfooter">
                    <button type="button" class="btn btn-primary sendmsg">发送</button>
                    <button type="button" class="btn btn-default msgCancel">取消</button>
                </div>
            </div>
        </div>
        <div class="tableModel emailcon none">
            <div class="tableModelTitle">发送邮件</div>
            <div>
                <div class="modal-body">
                    <div class="userListEmail"></div>
                    <form id="emailform" action="#" method="post" enctype="multipart/form-data">
                        <div id="emailthemecon">
                            <label>主题:</label>
                            <input id="emailtheme" name="subject" maxlength="26"/>
                        </div>
                        <!-- <div id="attachment">
                            <img src="../../img/admin/attachment.png">
                            <span id="attachbtn">附件</span>
                            <label id="attachexplain">(最大<span style="color:#cc0000;">2M</span>)</label>
                            <input name="file" type="file"/>
                        </div> -->
                        <textarea id="emailcontent" name="content" placeholder="内容:"></textarea>
                    </form>
                </div>
                <div class="modalfooter">
                    <button type="button" class="btn btn-primary sendemail">发送</button>
                    <button type="button" class="btn btn-default emailCancel">取消</button>
                </div>
            </div>
        </div>
        <div id="toolbar">
            <div class="btn-group">
                <button id="" type="button" class="btn btn-warning btn-sm">
                快捷筛选:
                </button>
                <button id="btn_add" type="button" class="btn btn-sm btn-default">
                待审核
                </button>
                <button id="btn_edit" type="button" class="btn btn-default btn-sm">
                审核通过
                </button>
                <button id="btn_delete" type="button" class="btn btn-default btn-sm">
                已通知
                </button>
                <button id="btn_delete" type="button" class="btn btn-default btn-sm">
                已报道
                </button>
            </div>
            
            <div class="btn-group">
                <button id="" type="button" class="btn btn-warning btn-sm">
                信息通知:
                </button>
                <button type="button" class="btn btn-default btn-sm message" data-toggle="modal" data-target="#myModal">短信</button>
                <button type="button" class="btn btn-default btn-sm email">邮件</button>
                <button type="button" class="btn btn-default btn-sm notice">站内信</button>
            </div>
            <div class="btn-group">
                <button id="" type="button" class="btn btn-warning btn-sm">
                导入导出:
                </button>
                <button id="downExcel" type="button" class="btn btn-default btn-sm">
                    <a href="#">导出</a>
                </button>
                <button id="upExcel" type="button" class="btn btn-default btn-sm">
                    <a href="#">导入</a>
                </button>
            </div>

        </div>
        <table id="texttable"></table>
	</div>
</div>
<script type="text/javascript" src="../../../js/common/footer.js"></script>
</body>
<script src="../../../js/jquery.min.js"></script>
<script src="../../../js/bootstrap.min.js"></script>
<script src="../../../js/bootstrap-table.min.js"></script>
<script src="../../../js/bootstrap-table-zh-CN.min.js"></script>
<script src="../../../js/ueditor/ueditor.config.js"></script>
<script src="../../../js/ueditor/ueditor.all.js"></script>
<script src="../../../js/ueditor/lang/zh-cn/zh-cn.js"></script>
<!-- 引入项目中带有左侧菜单的公共js -->
<script src="../../../js/common/main.js"></script>
<script src="../../../js/common/common.js"></script>

<script>

var msgModel = {}; // 短信模板数据
var tabTil = [];

// 实例化编辑器
var editor = UE.getEditor('emailcontent',{
    toolbars:[[
            'undo', //撤销
            'redo', //重做
            'preview', //预览
            'selectall', //全选
            'removeformat', //清除格式
            'cleardoc', //清空文档
            'bold', //加粗
            'indent', //首行缩进
            'italic', //斜体
            'underline', //下划线
            'strikethrough', //删除线
            'subscript', //下标
            'fontborder', //字符边框
            'superscript', //上标
            'formatmatch', //格式刷
            'justifyleft', //居左对齐
            'justifyright', //居右对齐
            'justifycenter', //居中对齐
            'justifyjustify', //两端对齐
            'forecolor', //字体颜色
            'backcolor', //背景色
            'insertorderedlist', //有序列表
            'insertunorderedlist', //无序列表
            'imagenone', //默认
            'imageleft', //左浮动
            'imageright', //右浮动
            'imagecenter', //居中
            'rowspacingtop', //段前距
            'rowspacingbottom', //段后距
            'lineheight', //行间距
            'edittip ', //编辑提示
            'touppercase', //字母大写
            'tolowercase', //字母小写
            'autotypeset', //自动排版
        ],[
            'spechars', //特殊字符
            'fontfamily', //字体
            'fontsize', //字号
            'paragraph', //段落格式
            'customstyle', //自定义标题
            'inserttable', //插入表格
            'insertrow', //前插入行
            'insertcol', //前插入列
            'mergeright', //右合并单元格
            'mergedown', //下合并单元格
            'deleterow', //删除行
            'deletecol', //删除列
            'splittorows', //拆分成行
            'splittocols', //拆分成列
            'splittocells', //完全拆分单元格
            'deletecaption', //删除表格标题
            'inserttitle', //插入标题
            'mergecells', //合并多个单元格
            'deletetable', //删除表格
            'insertparagraphbeforetable', //"表格前插入行"
            'edittable', //表格属性
            'edittd', //单元格属性
            'date', //日期
            'time', //时间
            'link', //超链接
            'unlink', //取消链接
            'simpleupload', //单图上传
            'attachment', //附件
        ]
    ],
    autoHeightEnabled: true,
    autoFloatEnabled: true
})

$(function(){
	// 获取左侧菜单列表数据(参数为请求地址)
	initMenu('../../../js/data/administrator.json','用户管理');
    // 获取ID值
    if(Request("id")){
        sessionStorage.setItem('actId',Request("id"));
    }
    $("#id").val(sessionStorage.getItem('actId'));

    $.ajax({
        type : 'post',
        url : basePath + 'admin/attend/list.do',
        data : {id: $("#id").val()},
        dataType : 'json',
        xhrFields: {
           withCredentials: true
        },
        crossDomain: true,
        success : function(result){
            console.log(result);
            if(result.flag){
                tabTil = result.data.activityRegConf;
                // 初始化表格，参数（表格列名称，表格数据）
                initTable(result.data.activityRegConf,result.data.userAttend);
                getMessageModel();
            } else {
                alert(result.msg);
            }
        },
        error : function(result) {
            alert("请求失败！！");
        }
    });

    $(document).on('click','.mystItem',function(){
        if($(this).is(':checked')){
            $(this).parent().siblings().find(".mystItem").removeAttr('checked');
        } else {
            return false;
        }
    });

    $("#downExcel").click(function(){
        var url = basePath + 'admin/attend/downexcel.do?id=' + $("#id").val();
        $(this).children().attr('href',url);
    })


    // ********************* 短信部分 *****************
    $(".message").click(function(){
        var elems = $("#texttable").bootstrapTable('getSelections');
        if(elems.length <= 0){
            alert("请选择要发送的人员");
            return false;
        }
        $(".messagecon").show(1000);
        var str ='';
        for(var i=0;i<elems.length;i++){
            str += '<button type="button" class="btn btn-default btn-xs">'+elems[i].name+'<input type="hidden" value="'+elems[i].id+'"/></button>';
        }
        $(".userListMsg").html(str);
    });
    $(".msgCancel").click(function(){
        $(".messagecon").hide(1000);
    });
    
    // 短信模板选择
    $("#msgmodelsel").change(function(){
        aStr = [];
        var htmlstr = '';
        var msgconstr = msgModel[$(this).val()];
        strOption(msgconstr,'${',0);
        for(var i=0; i<aStr.length; i++){
            if(i%2){
                htmlstr += '<input name="'+aStr[i]+'" class="msgInp"/>';
            } else {
                htmlstr += '<span>'+aStr[i]+'</span>';
            }
        }
        $(".msgDetail").html(htmlstr);
    });
    // 短信部分，输入区域自适应输入内容宽度
    $(document).on('keydown','.msgInp',function(e) {
        $(this).width(textWidth($(this).val())+25);
    });
    // 短信发送
     $(".sendmsg").click(function(){
        var msgTitle = $("#msgmodelsel").val();
        if(!msgTitle){
            alert("请选择短信模板并编辑短信！");
            return false;             
        }
        
        // 获取短信输入部分的内容
        var sendmsg = ''; //短信内容（用户输入部分）
        var sendmsgtemp = ''; //短信内容（用户输入部分）
        $('.msgInp').each(function(index){
            if(index > 0){
                sendmsgtemp += ',"' + $(this).attr("name") + '":"' + $(this).val() + '"';
            } else {
                sendmsgtemp += '"' + $(this).attr("name") + '":"' + $(this).val() + '"';
            }
        });
        sendmsg = '{' + sendmsgtemp + '}';
        // 获取用户参会id
        var inps = $(".userList input");
        var ids = '';
        for(var i=0;i<inps.length;i++){
            ids += '&attendId=' + $(inps[i]).val();
        }

        var postdata = 'msgTitle='+msgTitle+'&msgContext='+sendmsg+ids+"&id="+$("#id").val()+'&type=1';
        $.ajax({
            type : 'post',
            url : basePath + 'admin/message/send.do',
            data : postdata,
            dataType : 'json',
            xhrFields: {
               withCredentials: true
            },
            crossDomain: true,
            success : function(result){
                if(result.flag){
                    myAlert(result.msg);
                    $(".messagecon").hide(1000);
                } else {
                    alert(result.msg);
                }
            },
            error : function(result) {
                alert("请求失败！！");
            }
        });
     });

    // ********************* 短信部分-end *****************
    // ********************* 邮件部分 *****************
    $(".email").click(function(){
        var elems = $("#texttable").bootstrapTable('getSelections');
        if(elems.length <= 0){
            alert("请选择要发送的人员");
            return false;
        }
        $(".emailcon").show(1000);
        var str ='';
        for(var i=0;i<elems.length;i++){
            str += '<button type="button" class="btn btn-default btn-xs">'+elems[i].name+'<input type="hidden" value="'+elems[i].id+'"/></button>';
        }
        $(".userListEmail").html(str);
    });
    // 邮件发送
     $(".sendemail").click(function(){
        var msgTitle = $("#msgmodelsel").val();
        if(!msgTitle){
            alert("请选择短信模板并编辑短信！");
            return false;             
        }
        var postdata = 'msgTitle='+msgTitle+'&msgContext='+sendmsg+ids+"&id="+$("#id").val()+'&type=1';
        $.ajax({
            type : 'post',
            url : basePath + 'xxxx',
            data : postdata,
            dataType : 'json',
            xhrFields: {
               withCredentials: true
            },
            crossDomain: true,
            success : function(result){
                if(result.flag){
                } else {
                    alert(result.msg);
                }
            },
            error : function(result) {
                alert("请求失败！！");
            }
        });
     });

    $(".emailCancel").click(function(){
        $(".emailcon").hide(1000);
    });
    // ********************* 邮件部分-end *****************
    $(".notice").click(function(){
        console.log($("#texttable").bootstrapTable('getSelections'));
    });
});

function initTable(tabTitle,tabData){
    var column1 = [{
                    field: 'id',
                    rowspan: 2
                }, {
                    field: 'state',
                    rowspan: 2
                }, {
                    checkbox: true,
                    rowspan: 2,
                    valign: 'middle'
                }, {
                    title: '待审核',
                    align: 'center',
                    width: 60
                }, {
                    title: '审核通过',
                    align: 'center',
                    width: 60
                }, {
                    title: '已通知',
                    align: 'center',
                    width: 60
                }, {
                    title: '已报道',
                    align: 'center',
                    width: 60
                }];
                for(var i=0;i<tabTitle.length;i++){
                    var column = {};
                    column.field = tabTitle[i].name;
                    column.title = tabTitle[i].showname;
                    column.align = 'center';
                    column.valign = 'middle';
                    column.rowspan = 2;
                    column1.push(column);
                };
    var columns = [column1,[
        { 
            field: 'aaa',
            title: '<input type="checkbox" class="mystAll" name="staaa_all"/>',
            align: 'center',
            formatter: function(value, row, index){
                if(row.state == 1){
                    return '<input class="mystItem" value="1" name="staaa_item" type="checkbox" checked/>';
                }
                return '<input class="mystItem" value="1" name="staaa_item" type="checkbox"/>';
            }
        }, { 
            field: 'bbb',
            title: '<input type="checkbox" class="mystAll" name="stbbb_all"/>',
            align: 'center',
            formatter: function(value, row, index){
                if(row.state == 2){
                    return '<input class="mystItem" value="2" name="stbbb_item" type="checkbox" checked/>';
                }
                return '<input class="mystItem" value="2" name="stbbb_item" type="checkbox"/>';
            }
        }, { 
            field: 'ccc',
            title: '<input type="checkbox" class="mystAll" name="stccc_all"/>',
            align: 'center',
            formatter: function(value, row, index){
                if(row.state == 3){
                    return '<input class="mystItem" value="3" name="stccc_item" type="checkbox" checked/>';
                }
                return '<input class="mystItem" value="3" name="stccc_item" type="checkbox"/>';
            } 
        }, { 
            field: 'ddd',
            title: '<input type="checkbox" class="mystAll" name="stddd_all"/>',
            align: 'center',
            formatter: function(value, row, index){
                if(row.state == 4){
                    return '<input class="mystItem" value="4" name="stddd_item" type="checkbox" checked/>';
                }
                return '<input class="mystItem" value="4" name="stddd_item" type="checkbox"/>';
            } 
        }

    ]]

                
    $('#texttable').bootstrapTable({
        data: tabData,
        // url: '../../../js/data/customer.json',
        //method: 'get',                      //请求方式（*）
        dataType: 'json',
        dataLocale: 'zh-CN',               //表格汉化
        toolbar: '#toolbar',                //工具按钮用哪个容器
        striped: true,                      //是否显示行间隔色
        cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
        pagination: true,                   //是否显示分页（*）
        sortable: true,                     //是否启用排序
        sortOrder: "desc",                   //排序方式
        //searchable: true,
        searchFormatter: false,
        cellStyle: true,
        checkbox : true,

        //queryParams: oTableInit.queryParams,//传递参数（*）
        sidePagination: "client",           //分页方式：client客户端分页，server服务端分页（*）
        pageNumber:1,                       //初始化加载第一页，默认第一页
        pageSize: 10,                       //每页的记录行数（*）
        pageList: [10, 15, 20],        //可供选择的每页的行数（*）
        search: true,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
        //strictSearch: false,
        //showColumns: true,                  //是否显示所有的列
        showRefresh: true,                  //是否显示刷新按钮
        showColumns: true,
        //minimumCountColumns: 2,             //最少允许的列数
        // clickToSelect: true,                //是否启用点击选中行
        uniqueId: "id",                     //每一行的唯一标识，一般为主键列
        columns: columns,
        onClickRow:function(row,$element,field){
            
        },
        onClickCell:function(field,value,row,$element){
            var _thisSt = $element.find(".mystItem");
            if($(_thisSt).val()){
                if($(_thisSt).is(':checked')){
                    changeState(row.id,$(_thisSt).val());
                } else {
                    return false;
                }
            } else if(field == "name") {
                getUserInfo(row.id);
            }
        }
    });

    $("#texttable").bootstrapTable('hideColumn', 'id');
    $("#texttable").bootstrapTable('hideColumn', 'state');
}
function changeState(id,state){
    var postData = {id:id,state:state};
    $.ajax({
        type : 'post',
        url : basePath + 'admin/attend/save.do',
        data : postData,
        dataType : 'json',
        xhrFields: {
           withCredentials: true
        },
        crossDomain: true,
        success : function(result){
            console.log(result);
            if(result.flag){
                //alert(result.msg);
            } else {
                alert(result.msg);
            }

        },
        error : function(result) {
            alert("请求失败！！");
        }
    });
}

// 获取单个用户数据
function getUserInfo(id){
    $.ajax({
        type : 'post',
        url : basePath + 'admin/attend/get.do',
        data : {id:id},
        dataType : 'json',
        xhrFields: {
           withCredentials: true
        },
        crossDomain: true,
        success : function(result){
            console.log(result.data.userAttend);
            console.log(result.data.userAttend["corporation"]);
            if(result.flag){
                var tilname = [];
                for(var i=0;i<tabTil.length;i++){
                    var str = {};
                    str.name = tabTil[i].name;
                    str.showname = tabTil[i].showname;
                    tilname.push(str);
                };
                initUserInfo(tilname,result.data.userAttend);
            } else {
                alert(result.msg);
            }

        },
        error : function(result) {
            alert("请求失败！！");
        }
    });
}

// 展示单个用户数据
function initUserInfo(labels,data){
    $('#userModal').modal('show');
}
// 获取短信模板
function getMessageModel(){
    $.ajax({
        type : 'post',
        url : basePath + 'admin/message/list.do',
        dataType : 'json',
        xhrFields: {
           withCredentials: true
        },
        crossDomain: true,
        success : function(result){
            console.log(result);
            if(result.flag){
                msgModel = result.data;
            } else {
                alert(result.msg);
            }

        },
        error : function(result) {
            alert("请求失败！！");
        }
    })
}

// 字符串操作
var aStr = [];
function strOption(str,searchstr,fromindex) { // str: 字符串，searchstr： 要搜索的字符串，fromindex：搜索起始位置
    var start = fromindex;
    var end = 0;
    end = str.indexOf(searchstr,start);
    
    aStr.push(str.slice(start,end));
    if( end >=0 ) {
        if (searchstr == '${'){
            start = end + 2;
            strOption(str,'}',start);
        } else {
            start = end + 1;
            strOption(str,'${',start);
        }
    }
}

//获取文本宽度
var textWidth = function(text){ 
    var sensor = $('<pre>'+ text +'</pre>').css({display: 'none'}); 
    $('body').append(sensor); 
    var width = sensor.width();
    sensor.remove(); 
    return width;
};

</script>

</html>
